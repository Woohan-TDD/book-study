# Chapter 1. 도메인 모델 시작

- 도메인은 소프트웨어로 해결하고 하는 문제 영역이다.
    - 예를 들어, '온라인 서점'이 될 수 있다
- 한 도메인은 여러 하위 도메인으로 나뉠 수 있다
    - 예를 들어, '온라인 서점'이라면 주문, 결제, 배송 등 하위 도메인으로 나뉘어 진다.
    - 고정된 하위 도메인이 존재하는 게 아니다
    - 하위 도메인은 외부 서비스를 사용하는 경우도 될 수 있다
- 도메인을 이해하는데 도움이 된다면 표현 방식이 무엇인지는 중요하지 않다
    - 객체 기반 도메인 모델(ERD 느낌)도 되고, 상태 다이어그램(흐름)을 통한 모델도 될 수 있다
- 도메인 모델 패턴은 Presentation → Application → Domain → Infra 로 이뤄져 있다
    - Presentation
        - 사용자에게 정보를 보여준다. 외부 시스템도 사용자가 될 수 있다
    - Application
        - 사용자가 요청한 기능을 실행하는데 업무 로직을 직접 구현하지 않고 도메인 계층을 조합해서 기능을 실행한다.
    - Domain
        - 도메인의 규칙을 정의한다. **즉, 여기서 로직을 구현한다.**
        - 예를 들어, 출고 전에 배송지를 변경할 수 있다던가, 주문 취소는 배송 전에만 할 수 있다던가
    - Infra
        - DB나 메시징 시스템과 같은 외부 시스템과의 연동을 처리한다
- 처음부터 완벽한 개념 모델을 만들기보다는 전반적인 개요를 알 수 있는 수준으로 개념 모델을 작성해야 한다. 도메인에 대한 전체 윤곽을 이해하는데 집중하고, **구현하는 과정에서 개념 모델을 구현 모델로 점진적으로 발전시켜 나가야 한다.**
- 문서화는 꼭 하자. 정리한 문서를 참조해 소프트웨어의 전반을 빠르게 이해할 수 있도록 돕자.

### 주문이라는 도메인을 실제로 구현한다면?

- `Order` 도메인은 `OrderState`(주문 상태), `ShippingInfo`(배송정보)를 가지고 있다.
    - 출고 전에 배송지를 변경할 수 있다면 validate하는 로직도 Order 클래스 안에 있을 것
- 주문 도메인의 요구사항을 본다면 출고 상태로 변경하고, 배송지 정보를 변경하고, 주문을 취소하고, 결제 완료로 변경하고 등등... 주문 관련 로직이 여기에 들어간다.
    - 그래서 배송 상태로 변경하는 `changeShipped`, 배송지 정보를 변경하는 `changeShippingInfo`, 주문을 취소하는 `cancel` 등 많은 메서드가 Order 도메인에 들어갈 수 있다
- 주문 항목을 표현하는 `OrderLine`도 있는데 주문할 상품, 상품의 가격, 구매 개수를 포함하고 있다
    - 최소 한 종류 이상의 상품을 주문해야 하므로 `Order`는 최소 한 개 이상의 `OrderLine`을 가지고 있다
        - 그래서 코드를 보면 `Order` 안에 `List<OrderLine>` 으로 구현되어 있다
- 출고를 하면 배송지 정보를 변경할 수 없기 때문에 출고 상태에 따라 배송지 정보 변경 기능이 제약을 받는다. 그래서 **주문은 적어도 단순한 '출고'라는 상태가 아닌 '출고 전'인지, '출고 후'인지 상태를 표현할 수 있어야 한다.**
    - 그래서 `OrderState`에 SHIPPED, DELIVERING가 나오게 된다.

### 도메인은 크게 Value와 Entity로 구분할 수 있다

- Entity는 식별자가 있다
    - 식별자는 도메인에 따라 다르다.
    - 주문번호, 운송장번호 같은 식별자는 특정 규칙에 따라 생성한다.
    - 회원 아이디나 이메일 같은 식별자는 DB의 AutoIncrement를 사용한다.
- Value는 개념적으로 완전한 하나다
    - 받는 사람을 위한 `Receiver`라는 Value 클래스를 만들 수 있다
        - 받는 사람은 여러 필드(name, phoneNumber 등)가 들어간다
    - 돈 같은 경우도 단순한 `int` 타입이 아니라 `Money`로 하면 훨씬 직관적이며 컨트롤할 수 있다.
        - 돈은 불변으로 만들어 안전하게 사용할 수 있도록 하자
- equals And Hashcode에 신경쓰자.
    - Entity는 식별자만
    - Value는 모든 필드
- 도메인 모델에 set 메서드 넣지 않기
    - 도메인이 스스로 상태나 행동을 결정하게 하지 않는다.
    - 특히 Value 타입은 값 그 자체로 사용되기 위해서 불변으로 만들자
    - 생성 시점에 필요한 데이터를 모두 받아서 불변으로 만들자
- 예전에는 DTO에도 get, set을 구현해야 했는데 요즘에는 프레임워크가 잘 되어있어서 리플렉션을 통해 안으로 들어가도 된다. DTO도 불변 객체가 되어 불변의 장점을 DTO까지 확장시켜도 좋다.
- 도메인 용어는 영어를 잘 사용해야 된다.
    - OrderState 같은 Enum을 구현할 때 상태를 최대한 잘 나타낼 수 있도록 하자.
