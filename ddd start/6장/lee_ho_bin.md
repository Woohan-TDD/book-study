# Chapter 6. 응용 서비스와 표현 영역

## 표현 영역

- 표현 영역은 사용자의 요청을 해석한다.
- HTTP 요청을 받아 사용자가 어떤 기능을 실행하고 싶은지 판별하고 응용서비스를 실행한다

## 응용 영역

- 응용 영역은 사용자가 원하는 기능을 제공한다
- 전달받은 데이터 형식이 다르기 때문에 응용 서비스가 요구하는 형식으로 사용자 요청을 변환한다  (e.g. `XXXRequestDto.toServiceDto()` )
- 응용 영역은 표현 영역에 의존하지 않는다. (e.g. 서비스가 컨트롤러를 필드로 갖고있지 않다)
- 표현 영역과 도메인 영역을 연결시켜준다는 의미에서 퍼사드의 역할을 갖는다.
    - 즉, 표현 영역은 도메인의 구체적인 기능을 알 필요 없이 서비스의 어떤 기능을 실행시키기만 하면 된다.
- 보통 도메인 애그리거트의 `Repository`에서 find를 한 후, 기능을 실행시키고 끝낸다.
- 도메인 로직을 도메인 영역에 구현해서 응집도를 높이자. 응용 영역에서는 도메인 영역을 호출하기만 하자.
    - e.g. 비밀번호 변경 기능은 `Member` 도메인 영역에서 구현하고 응용영역에서 `Member` 애그리거트를 호출해 사용

## 응용 서비스

두 가지 방식으로 응용 서비스를 구현할 수 있다

- 모든 기능을 하나의 응용 서비스 클래스에 구현
    - `MemberService`
- 여러 기능(2~3개)을 여러 응용 서비스 클래스에 구현
    - e.g. `changePasswordService`, `initMemberService`...
    - 여기서 나오는 공통 로직은 `MemberServiceHelper` 클래스에 모음
    - 역할이 분명히 나눠져 있기 때문에 이걸 더 선호함
- 인터페이스는 구현 클래스가 많은 경우, 런타임에 구현 객체를 교체하는 경우에 만든다. 무의식적으로 `Service`, `ServiceImpl` 로 만들지 말자.
- 응용서비스에서 애그리거트를 리턴하게 되면 표현 영역에서 응용서비스를 쓰기 때문에 표현 영역에서도 도메인의 로직을 실행할 수 있다. 이는 코드의 응집도를 낮추고 도메인을 더 바깥으로 노출시키게 되어 좋은 설계 방법이 아니다.

> 각각의 레이어에서 필요한 데이터만 반환하자 (e.g. `HttpServletRequest` → `XXXRequestDto` → `XXXServiceDto` → `Repository`)

- `Event.raise()`, `Event.handler()`를 사용해서 어떤 이벤트가 발생하면 어떤 기능을 실행하도록 할 수 있다. 이런 방식으로 구현하면 시스템간의 의존도를 낮출 수 있다. (의존하는 게 아니고(계속 가지고 있는 게 아니고) 어떤 일이 발생하면 어떤 기능을 실행하도록 하는 거니까)

## 요청에 대한 검증은 어디까지 해야할까?

물론 모든 레이어에서 검증을 거치면 정말 안전한 서비스가 될 수 있다. 그러나 요청에 변경이 일어날 때마다 각 레이어에 대해서 다 변경시켜줘야하니 공수가 많이 들고 로직 실행에 있어서도 오래걸린다. 즉, 어느정도 트레이드 오프가 있다. 아마 상황에 따라 다를 것 같다.

책에서 이야기하는 추천 방법은 아래와 같다. 나도 이런 방식으로 하고 있다.

- 표현 영역 : 필수 값, 값의 형식, 범위 등을 검증
- 응용 서비스 : 데이터의 존재 유무, 중복 등과 같은 논리적 오류를 검증

그리고 책에서는 Controller에서 모두 처리하고 있는데 `@ControllerAdvice`, `@ExceptionHandler`를 사용하면 더 쉽게 공통으로 처리할 수 있다.

## 권한 검사

- URL으로 처리하는 인증 여부는 서블릿 필터에서 할 수 있다.
- URL만으로 접근 제어를 할 수 없는 경우, `@PreAuthorize`를 사용해서 해당 메서드에 대한 권한을 검사할 수 있다.
- 스프링 시큐리티같은 프레임워크를 사용할 수 있으나 이런 프레임워크를 사용하기 어렵다면 권한을 검사하는 로직을 직접 구현하는 것도 방법이다. (오히려 유지보수 측면에서 유리할 수 있다)

## 조회 전용 기능

- 서비스에서 수행하는 추가적인 로직이 없을뿐더러 조회 전용 기능이어서 트랜잭션이 필요하지 않다면 표현 영역에서 바로 조회 전용 기능을 사용해도 된다.

> 서비스 레이어를 만드는 이유도 생각해보자. 만들 이유가 없다면 만들지 않아도 된다.
